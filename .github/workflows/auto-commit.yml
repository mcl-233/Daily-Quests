name: Daily GitHub Activity

env:
  TZ: Asia/Shanghai

on:
  schedule:
    - cron: '0 0 * * *'  # UTC 0 ç‚¹è§¦å‘ = åŒ—äº¬æ—¶é—´ 8 ç‚¹
  workflow_dispatch:

jobs:
  daily-activity:
    runs-on: ubuntu-latest

    steps:
      # 0. Upgrade gh CLI
      - name: Upgrade gh CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq

      # 1. Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_PAT }}

      # 2. Weekend lazy check
      - name: Weekend lazy check
        id: lazy
        run: |
          DOW=$(date +%u)
          if [ "$DOW" -gt 5 ] && [ $((RANDOM % 100)) -lt 20 ]; then
            echo "lazy=true" >> $GITHUB_OUTPUT
            echo "ðŸ˜´ ä»Šå¤©æ˜¯å‘¨æœ«ï¼Œé€‰æ‹©æ‘¸é±¼ âœ¨" >> update.md
          else
            echo "lazy=false" >> $GITHUB_OUTPUT
          fi

      # 3. Random delay
      - name: Random delay
        if: steps.lazy.outputs.lazy != 'true'
        run: |
          DELAY=$((RANDOM % 2))
          sleep $DELAY

      # 4. Ensure update.md exists
      - name: Ensure update.md exists
        if: steps.lazy.outputs.lazy != 'true'
        run: |
          [ -f update.md ] || echo "# Daily Commit Log" > update.md

      # 5. Random commit
      - name: Commit update.md
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_USER: ${{ secrets.GH_USER }}
          GH_EMAIL: ${{ secrets.GH_EMAIL }}
        run: |
          PROB_COMMIT=70
          RAND=$((RANDOM % 100 + 1))
          if [ $RAND -le $PROB_COMMIT ]; then
            git config user.name "$GH_USER"
            git config user.email "$GH_EMAIL"
            echo "$(date '+%Y-%m-%d %H:%M:%S') - æ—¥å¿—æ›´æ–° ðŸŒ±" >> update.md
            git add update.md
            git commit -m "chore: daily log update" || echo "No changes"
            git fetch origin main
            git rebase origin/main || git rebase --abort
            git push origin HEAD:main || git push --force-with-lease origin HEAD:main
            echo "âœ… æ‰§è¡Œäº† Commit æ“ä½œ" >> update.md
          else
            echo "âŒ è·³è¿‡äº† Commit æ“ä½œ" >> update.md
          fi

      # 6. Create Issue
      - name: Create Issue
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PROB_ISSUE=35
          RAND=$((RANDOM % 100 + 1))
          if [ $RAND -le $PROB_ISSUE ]; then
            LABELS=("bug" "enhancement" "discussion")
            LABEL=${LABELS[$RANDOM % ${#LABELS[@]}]}
            gh issue create \
              --title "Daily Issue - $(date '+%Y-%m-%d %H:%M:%S')" \
              --body "éšæœºç”Ÿæˆæ¯æ—¥ Issue ðŸŒ±" \
              --label "$LABEL" \
              --repo $GITHUB_REPOSITORY
            echo "âœ… åˆ›å»ºäº†ä¸€ä¸ª Issue (æ ‡ç­¾: $LABEL)" >> update.md
          else
            echo "âŒ è·³è¿‡äº† Issue åˆ›å»º" >> update.md
          fi

      # 7. Create Pull Request
      - name: Create Pull Request
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          GH_USER: ${{ secrets.GH_USER }}
          GH_EMAIL: ${{ secrets.GH_EMAIL }}
        run: |
          PROB_PR=35
          RAND=$((RANDOM % 100 + 1))
          if [ $RAND -le $PROB_PR ]; then
            BRANCH="daily-pr-$(date '+%Y%m%d%H%M%S')"
            git checkout -b "$BRANCH"
            git config user.name "$GH_USER"
            git config user.email "$GH_EMAIL"
            echo "$(date '+%Y-%m-%d %H:%M:%S') - è‡ªåŠ¨ PR æ—¥å¿— ðŸŒ±" >> update.md
            git add update.md
            git commit -m "chore: daily PR update"
            git push origin "$BRANCH"
            gh pr create --title "Daily PR - $(date '+%Y-%m-%d %H:%M:%S')" \
                         --body "éšæœºç”Ÿæˆæ¯æ—¥ PR ðŸŒ±" \
                         --base main --head "$BRANCH" --repo $GITHUB_REPOSITORY
            echo "âœ… æäº¤äº†ä¸€ä¸ª PR (åˆ†æ”¯: $BRANCH)" >> update.md
          else
            echo "âŒ è·³è¿‡äº† PR åˆ›å»º" >> update.md
          fi

      # 8. Auto Review & Merge PR
      - name: Auto Review and Merge
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PR_LIST=$(gh pr list --state open --repo "$GITHUB_REPOSITORY" --json number -q '.[].number')
          if [ -n "$PR_LIST" ]; then
            PR_NUM=$(echo "$PR_LIST" | shuf -n1)
            gh pr review "$PR_NUM" --comment --body "ðŸ¤– è‡ªåŠ¨å®¡æŸ¥ï¼šLGTMï¼"
            gh pr merge "$PR_NUM" --squash --delete-branch --repo "$GITHUB_REPOSITORY" --admin
            echo "âœ… è‡ªåŠ¨åˆå¹¶äº† PR #$PR_NUM" >> update.md
          else
            echo "âŒ æ²¡æœ‰å¯åˆå¹¶çš„ PR" >> update.md
          fi

      # 9. Auto Close Issues
      - name: Auto Close Issues
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          ISSUE_LIST=$(gh issue list --state open --repo "$GITHUB_REPOSITORY" --json number -q '.[].number')
          if [ -n "$ISSUE_LIST" ]; then
            ISSUE_NUM=$(echo "$ISSUE_LIST" | shuf -n1)
            gh issue close "$ISSUE_NUM" --repo "$GITHUB_REPOSITORY"
            echo "âœ… è‡ªåŠ¨å…³é—­äº† Issue #$ISSUE_NUM" >> update.md
          else
            echo "âŒ æ²¡æœ‰éœ€è¦å…³é—­çš„ Issue" >> update.md
          fi

      # 10. Star & Fork repos (Star åŽç«‹å³ Fork)
      - name: Star & Fork repos
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          TARGET_USER: ${{ secrets.TARGET_USER }}
        run: |
          # æ¯å¤©éšæœºèŽ·å– 3~5 ä¸ªä»“åº“
          COUNT=$((RANDOM % 3 + 3))
          REPOS=$(gh repo list "$TARGET_USER" --limit $COUNT --json nameWithOwner -q '.[].nameWithOwner')

          for REPO in $REPOS; do
            echo "ðŸ” å¤„ç†ä»“åº“: $REPO"

            # æ£€æŸ¥æ˜¯å¦å·² Star
            if gh api "/user/starred/$REPO" >/dev/null 2>&1; then
              echo "âš ï¸ å·²ç» Star è¿‡ä»“åº“: $REPO" >> update.md
              continue
            fi

            # â­ Star
            gh api -X PUT -H "Accept: application/vnd.github+json" "/user/starred/$REPO" --silent
            echo "â­ Star -> $REPO" >> update.md

            # ðŸ´ Forkï¼ˆåªæœ‰ Star æˆåŠŸåŽæ‰ Forkï¼‰
            if gh repo view "${{ github.repository_owner }}/$(basename $REPO)" >/dev/null 2>&1; then
              echo "âš ï¸ å·²ç» Fork è¿‡ä»“åº“: $REPO" >> update.md
            else
              gh repo fork "$REPO" --clone=false --remote=false
              echo "ðŸ´ Fork -> $REPO" >> update.md
            fi
          done

      # 11. Clean up old merged branches
      - name: Clean up old merged branches
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          NOW=$(date +%s)
          gh pr list --state merged --repo "$GITHUB_REPOSITORY" --json number,headRefName,mergedAt -q '.[]' | while read pr; do
            PR_NUM=$(echo "$pr" | jq -r '.number')
            BRANCH=$(echo "$pr" | jq -r '.headRefName')
            MERGED_AT=$(echo "$pr" | jq -r '.mergedAt')
            MERGED_TS=$(date -u -d "$MERGED_AT" +%s)
            AGE=$(( (NOW - MERGED_TS) / 86400 ))
            if [[ "$BRANCH" == daily-pr-* && $AGE -gt 7 ]]; then
              git push origin --delete "$BRANCH" || true
              echo "ðŸ—‘ï¸ åˆ é™¤å·²åˆå¹¶è¶…è¿‡ 7 å¤©çš„åˆ†æ”¯ $BRANCH (#$PR_NUM)" >> update.md
            fi
          done

      # 12. Daily summary
      - name: Write summary
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_USER: ${{ secrets.GH_USER }}
          GH_EMAIL: ${{ secrets.GH_EMAIL }}
        run: |
          NOW=$(date +"%Y-%m-%d %H:%M:%S")
          LOG_FILE="update.md"
          ISSUE_COUNT=$(grep -c 'âœ… åˆ›å»ºäº†ä¸€ä¸ª Issue' $LOG_FILE || echo 0)
          PR_COUNT=$(grep -c 'âœ… æäº¤äº†ä¸€ä¸ª PR' $LOG_FILE || echo 0)
          MERGED_COUNT=$(grep -c 'âœ… è‡ªåŠ¨åˆå¹¶äº† PR' $LOG_FILE || echo 0)
          STAR_COUNT=$(grep -c 'âœ… Star' $LOG_FILE || echo 0)
          FORK_COUNT=$(grep -c 'âœ… Fork' $LOG_FILE || echo 0)
          CLEAN_BRANCH_COUNT=$(grep -c 'ðŸ—‘ï¸ åˆ é™¤å·²åˆå¹¶è¶…è¿‡ 7 å¤©çš„åˆ†æ”¯' $LOG_FILE || echo 0)

          echo -e "\n### ðŸŒ™ ä»Šæ—¥æ€»ç»“" >> "$LOG_FILE"
          echo "[$NOW] ä»Šæ—¥ä»»åŠ¡å®Œæˆ âœ…" >> "$LOG_FILE"
          echo "- ðŸ“ åˆ›å»º Issue: $ISSUE_COUNT" >> "$LOG_FILE"
          echo "- ðŸ“¦ åˆ›å»º PR: $PR_COUNT" >> "$LOG_FILE"
          echo "- âœ… åˆå¹¶ PR: $MERGED_COUNT" >> "$LOG_FILE"
          echo "- â­ Star: $STAR_COUNT" >> "$LOG_FILE"
          echo "- ðŸ´ Fork: $FORK_COUNT" >> "$LOG_FILE"
          echo "- ðŸ§¹ æ¸…ç†åˆ†æ”¯: $CLEAN_BRANCH_COUNT" >> "$LOG_FILE"

          git config user.name "$GH_USER"
          git config user.email "$GH_EMAIL"
          git add "$LOG_FILE"
          git commit -m "chore: daily summary with counts" || echo "No changes"
          git fetch origin main
          git rebase origin/main || git rebase --abort
          git push origin HEAD:main || git push --force-with-lease origin HEAD:main
