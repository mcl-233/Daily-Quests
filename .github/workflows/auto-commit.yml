name: Daily GitHub Activity

env:
  TZ: Asia/Shanghai

on:
  schedule:
    - cron: '0 00 * * *'  # UTC 0 ç‚¹è§¦å‘ = åŒ—äº¬æ—¶é—´ 8 ç‚¹
  workflow_dispatch:

jobs:
  daily-activity:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_PAT }}

      # 2. Start time block
      - name: Start time block
        id: starttime
        run: |
          TIME=$(date '+%H:%M:%S')
          echo "### â° $TIME å¼€å§‹ä»»åŠ¡" >> update.md

      # 3. Weekend lazy check
      - name: Weekend lazy check
        id: lazy
        run: |
          TIME=$(date '+%H:%M:%S')
          DOW=$(date +%u)
          if [ "$DOW" -gt 5 ] && [ $((RANDOM % 100)) -lt 20 ]; then
            echo "lazy=true" >> $GITHUB_OUTPUT
            echo "- âœ¨ ä»Šå¤©å‘¨æœ«ï¼Œé€‰æ‹©æ‘¸é±¼ ($TIME)" >> update.md
          else
            echo "lazy=false" >> $GITHUB_OUTPUT
            echo "- ðŸ’ª å·¥ä½œæ—¥ï¼Œæ­£å¸¸æ‰§è¡Œ ($TIME)" >> update.md
          fi

      # 4. Random delay
      - name: Random delay
        if: steps.lazy.outputs.lazy != 'true'
        run: |
          DELAY=$((RANDOM % 2))
          TIME=$(date '+%H:%M:%S')
          echo "- â³ éšæœºå»¶è¿Ÿ $DELAY ç§’ ($TIME)" >> update.md
          sleep $DELAY

      # 5. Ensure update.md exists
      - name: Ensure update.md exists
        if: steps.lazy.outputs.lazy != 'true'
        run: |
          [ -f update.md ] || echo -e "# ðŸŒ¿ æ¯æ—¥ GitHub æ´»åŠ¨æ—¥å¿—\n\n## ðŸ“… æ—¥æœŸï¼š$(date '+%Y-%m-%d')\n" > update.md
          TIME=$(date '+%H:%M:%S')
          echo "- ðŸ“„ ç¡®è®¤ update.md æ–‡ä»¶å­˜åœ¨ ($TIME)" >> update.md

      # 6. Commit update.md (å›ºå®šæäº¤)
      - name: Commit update.md
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_USER: ${{ secrets.GH_USER }}
          GH_EMAIL: ${{ secrets.GH_EMAIL }}
        run: |
          TIME=$(date '+%H:%M:%S')
          git config user.name "$GH_USER"
          git config user.email "$GH_EMAIL"
          echo "- ðŸŒ± æäº¤æ—¥å¿—æ›´æ–° ($TIME)" >> update.md
          echo "$(date '+%Y-%m-%d %H:%M:%S') - æ—¥å¿—æ›´æ–°" >> update.md
          git add update.md
          git commit -m "chore: daily log update" || echo "No changes"
          git fetch origin main
          git rebase origin/main || git rebase --abort
          git push origin HEAD:main || git push --force-with-lease origin HEAD:main

      # 7. Create Issue
      - name: Create Issue
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          TIME=$(date '+%H:%M:%S')
          PROB_ISSUE=35
          RAND=$((RANDOM % 100 + 1))
          if [ $RAND -le $PROB_ISSUE ]; then
            LABELS=("bug" "enhancement" "discussion")
            LABEL=${LABELS[$RANDOM % ${#LABELS[@]}]}
            TITLE="Daily Issue - $(date '+%Y-%m-%d %H:%M:%S')"
            gh issue create --title "$TITLE" --body "éšæœºç”Ÿæˆæ¯æ—¥ Issue ðŸŒ±" --label "$LABEL" --repo $GITHUB_REPOSITORY
            echo "- ðŸ“ åˆ›å»º Issue ($LABEL) ($TIME)" >> update.md
          else
            echo "- ðŸ“ ä»Šå¤©ä¸åˆ›å»º Issue ($TIME)" >> update.md
          fi

      # 8. Create Pull Request
      - name: Create Pull Request
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          GH_USER: ${{ secrets.GH_USER }}
          GH_EMAIL: ${{ secrets.GH_EMAIL }}
        run: |
          TIME=$(date '+%H:%M:%S')
          PROB_PR=35
          RAND=$((RANDOM % 100 + 1))
          if [ $RAND -le $PROB_PR ]; then
            BRANCH="daily-pr-$(date '+%Y%m%d%H%M%S')"
            git checkout -b "$BRANCH"
            git config user.name "$GH_USER"
            git config user.email "$GH_EMAIL"
            git add update.md
            git commit -m "chore: daily PR update" || echo "No changes"
            git push origin "$BRANCH"
            TITLE="Daily PR - $(date '+%Y-%m-%d %H:%M:%S')"
            gh pr create --title "$TITLE" --body "éšæœºç”Ÿæˆæ¯æ—¥ PR ðŸŒ±" --base main --head "$BRANCH" --repo $GITHUB_REPOSITORY
            echo "- ðŸ“¦ åˆ›å»º PR ($TIME)" >> update.md
          else
            echo "- ðŸ“¦ ä»Šå¤©ä¸åˆ›å»º PR ($TIME)" >> update.md
          fi

      # 9. Auto Review & Merge PR
      - name: Auto Review and Merge
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          TIME=$(date '+%H:%M:%S')
          PR_LIST=$(gh pr list --state open --repo "$GITHUB_REPOSITORY" --json number -q '.[].number')
          if [ -n "$PR_LIST" ]; then
            PR_NUM=$(echo "$PR_LIST" | shuf -n1)
            gh pr review "$PR_NUM" --comment --body "ðŸ¤– è‡ªåŠ¨å®¡æŸ¥ï¼šLGTMï¼"
            gh pr merge "$PR_NUM" --squash --delete-branch --repo "$GITHUB_REPOSITORY" --admin
            echo "- âœ… åˆå¹¶ PR #$PR_NUM ($TIME)" >> update.md
          fi

      # 10. Auto Close Issues
      - name: Auto Close Issues
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          TIME=$(date '+%H:%M:%S')
          ISSUE_LIST=$(gh issue list --state open --repo "$GITHUB_REPOSITORY" --json number -q '.[].number')
          if [ -n "$ISSUE_LIST" ]; then
            ISSUE_NUM=$(echo "$ISSUE_LIST" | shuf -n1)
            gh issue close "$ISSUE_NUM" --repo "$GITHUB_REPOSITORY"
            echo "- ðŸš« å…³é—­ Issue #$ISSUE_NUM ($TIME)" >> update.md
          else
            echo "- ðŸš« æ— éœ€å…³é—­ Issue ($TIME)" >> update.md
          fi

      # 11. Star & Fork user repos
      - name: Star & Fork user repos
        if: steps.lazy.outputs.lazy != 'true'
        id: starforkuser
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          TIME=$(date '+%H:%M:%S')
          TARGET_USER="MooCheelee"
          repos=$(gh repo list $TARGET_USER --json nameWithOwner -q '.[].nameWithOwner')
          STAR_COUNT=0
          FORK_COUNT=0
          for repo in $repos; do
            if gh api "user/starred/$repo" &>/dev/null; then
              echo "âœ… å·²åŠ æ˜Ÿè¿‡ $repoï¼Œè·³è¿‡ â­"
            else
              gh api --method PUT "user/starred/$repo"
              echo "- â­ Starred $repo ($TIME)" >> update.md
              STAR_COUNT=$((STAR_COUNT+1))
            fi
            REPONAME=$(echo "$repo" | cut -d'/' -f2)
            MY_REPO="${GITHUB_ACTOR}/${REPONAME}"
            if gh repo view "$MY_REPO" &>/dev/null; then
              echo "âœ… å·² Fork è¿‡ $repoï¼Œè·³è¿‡ ðŸ´"
            else
              gh repo fork "$repo" --clone=false --default-branch-only
              echo "- ðŸ´ Forked $repo ($TIME)" >> update.md
              FORK_COUNT=$((FORK_COUNT+1))
            fi
          done
          echo "- â­ å…±æ–°å¢ž $STAR_COUNT ä¸ª Star, ðŸ´ å…±æ–°å¢ž $FORK_COUNT ä¸ª Fork ($TIME)" >> update.md
          echo "STAR_USER_COUNT=$STAR_COUNT" >> $GITHUB_OUTPUT
          echo "FORK_USER_COUNT=$FORK_COUNT" >> $GITHUB_OUTPUT

      # 12. Clean up old merged branches and logs
      - name: Clean up old merged branches and logs
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          TIME=$(date '+%H:%M:%S')
          NOW=$(date +%s)
          MERGED_BRANCHES=$(gh pr list --state merged --repo "$GITHUB_REPOSITORY" --json headRefName,mergedAt -q '.[] | select(.headRefName | test("^daily-pr-")) | .headRefName')

          if [ -z "$MERGED_BRANCHES" ]; then
            echo "- ðŸ—‘ï¸ æ— éœ€åˆ é™¤æ—§åˆ†æ”¯ ($TIME)"
          else
            echo "$MERGED_BRANCHES" | while read BRANCH; do
              MERGED_AT=$(gh pr list --state merged --repo "$GITHUB_REPOSITORY" --json headRefName,mergedAt -q ".[] | select(.headRefName==\"$BRANCH\") | .mergedAt")
              MERGED_TS=$(date -u -d "$MERGED_AT" +%s)
              AGE=$(( (NOW - MERGED_TS) / 86400 ))
              if [ $AGE -gt 7 ]; then
                git push origin --delete "$BRANCH" || true
                echo "- ðŸ—‘ï¸ åˆ é™¤å·²åˆå¹¶è¶…è¿‡ 7 å¤©çš„åˆ†æ”¯ $BRANCH ($TIME)" >> update.md
              fi
            done
          fi
          echo "- ðŸ§¹ æ¸…ç†è¶…è¿‡ 7 å¤©çš„æ—§æ—¥å¿— ($TIME)" >> update.md

      # 13. Daily summary
      - name: Write summary
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_USER: ${{ secrets.GH_USER }}
          GH_EMAIL: ${{ secrets.GH_EMAIL }}
        run: |
          NOW=$(date '+%Y-%m-%d %H:%M:%S')
          LOG_FILE="update.md"
          COMMIT_COUNT=$(grep -c 'ðŸŒ±' $LOG_FILE || echo 0)
          ISSUE_COUNT=$(grep -c 'ðŸ“' $LOG_FILE || echo 0)
          PR_COUNT=$(grep -c 'ðŸ“¦' $LOG_FILE || echo 0)
          MERGED_COUNT=$(grep -c 'âœ…' $LOG_FILE || echo 0)
          CLOSED_COUNT=$(grep -c 'ðŸš«' $LOG_FILE || echo 0)
          CLEAN_LOG_COUNT=$(grep -c 'ðŸ§¹' $LOG_FILE || echo 0)
          CLEAN_BRANCH_COUNT=$(grep -c 'ðŸ—‘ï¸' $LOG_FILE || echo 0)
          echo -e "\n---\n\n## ðŸŒ™ ä»Šæ—¥æ€»ç»“ ($NOW)" >> "$LOG_FILE"
          echo "- ðŸŒ± æ—¥å¿—æ¡ç›®: $COMMIT_COUNT" >> "$LOG_FILE"
          echo "- ðŸ“ åˆ›å»º Issue: $ISSUE_COUNT" >> "$LOG_FILE"
          echo "- ðŸ“¦ åˆ›å»º PR: $PR_COUNT" >> "$LOG_FILE"
          echo "- âœ… åˆå¹¶ PR: $MERGED_COUNT" >> "$LOG_FILE"
          echo "- ðŸš« å…³é—­ Issue: $CLOSED_COUNT" >> "$LOG_FILE"
          echo "- ðŸ§¹ æ¸…ç†æ—¥å¿—: $CLEAN_LOG_COUNT" >> "$LOG_FILE"
          echo "- ðŸ—‘ï¸ æ¸…ç†åˆ†æ”¯: $CLEAN_BRANCH_COUNT" >> "$LOG_FILE"
          git config user.name "$GH_USER"
          git config user.email "$GH_EMAIL"
          git add "$LOG_FILE"
          git commit -m "chore: daily summary with counts" || echo "No changes"
          git fetch origin main
          git rebase origin/main || git rebase --abort
          git push origin HEAD:main || git push --force-with-lease origin HEAD:main
