name: Daily GitHub Activity

env:
  TZ: Asia/Shanghai  # ÂÖ®Â±ÄÂåó‰∫¨Êó∂Èó¥

on:
  schedule:
    - cron: '0 00 * * *'  # UTC 0 ÁÇπËß¶Âèë = Âåó‰∫¨Êó∂Èó¥ 8 ÁÇπ
  workflow_dispatch:

jobs:
  daily-activity:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_PAT }}

      # 2. Weekend lazy check
      - name: Weekend lazy check
        id: lazy
        run: |
          DOW=$(date +%u)
          if [ "$DOW" -gt 5 ] && [ $((RANDOM % 100)) -lt 20 ]; then
            echo "lazy=true" >> $GITHUB_OUTPUT
            echo "‰ªäÂ§©Âë®Êú´ÔºåÈÄâÊã©Êë∏È±º ‚ú®" >> update.md
          else
            echo "lazy=false" >> $GITHUB_OUTPUT
          fi

      # 3. Random delay
      - name: Random delay
        if: steps.lazy.outputs.lazy != 'true'
        run: |
          DELAY=$((RANDOM % 2))   # 0~6Â∞èÊó∂ÈöèÊú∫Âª∂Ëøü
          sleep $DELAY

      # 4. Ensure update.md exists
      - name: Ensure update.md exists
        if: steps.lazy.outputs.lazy != 'true'
        run: |
          [ -f update.md ] || echo "# Daily Commit Log" > update.md

      # 5. Random commit (Ê∑±ÁªøÊ†ºÂ≠êÊ¶ÇÁéá)
      - name: Commit update.md
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_USER: ${{ secrets.GH_USER }}
          GH_EMAIL: ${{ secrets.GH_EMAIL }}
        run: |
          PROB_COMMIT=60
          RAND=$((RANDOM % 100 + 1))
          if [ $RAND -le $PROB_COMMIT ]; then
            git config user.name "$GH_USER"
            git config user.email "$GH_EMAIL"
            echo "$(date '+%Y-%m-%d %H:%M:%S') - Êó•ÂøóÊõ¥Êñ∞ üå±" >> update.md
            git add update.md
            git commit -m "chore: daily log update" || echo "No changes"
            git fetch origin main
            git rebase origin/main || git rebase --abort
            git push origin HEAD:main || git push --force-with-lease origin HEAD:main
          else
            echo "‰ªäÂ§©‰∏ç commit üåø" >> update.md

      # 6. Random Issue creation
      - name: Create Issue
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PROB_ISSUE=40
          RAND=$((RANDOM % 100 + 1))
          if [ $RAND -le $PROB_ISSUE ]; then
            LABELS=("bug" "enhancement" "discussion")
            LABEL=${LABELS[$RANDOM % ${#LABELS[@]}]}
            gh issue create --title "Daily Issue - $(date '+%Y-%m-%d %H:%M:%S')" \
                            --body "ÈöèÊú∫ÁîüÊàêÊØèÊó• Issue üå±" \
                            --label "$LABEL" \
                            --repo $GITHUB_REPOSITORY
            echo "üìù ÂàõÂª∫‰∫Ü‰∏Ä‰∏™ Issue ($LABEL)" >> update.md
          else
            echo "‰ªäÂ§©‰∏çÂàõÂª∫ Issue üåø" >> update.md

      # 7. Random PR creation
      - name: Create Pull Request
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          GH_USER: ${{ secrets.GH_USER }}
          GH_EMAIL: ${{ secrets.GH_EMAIL }}
        run: |
          PROB_PR=40
          RAND=$((RANDOM % 100 + 1))
          if [ $RAND -le $PROB_PR ]; then
            BRANCH="daily-pr-$(date '+%Y%m%d%H%M%S')"
            git checkout -b "$BRANCH"
            git config user.name "$GH_USER"
            git config user.email "$GH_EMAIL"
            echo "$(date '+%Y-%m-%d %H:%M:%S') - Ëá™Âä® PR Êó•Âøó üå±" >> update.md
            git add update.md
            git commit -m "chore: daily PR update"
            git push origin "$BRANCH"
            gh pr create --title "Daily PR - $(date '+%Y-%m-%d %H:%M:%S')" \
                         --body "ÈöèÊú∫ÁîüÊàêÊØèÊó• PR üå±" \
                         --base main --head "$BRANCH" --repo $GITHUB_REPOSITORY
          else
            echo "‰ªäÂ§©‰∏çÂàõÂª∫ PR üåø" >> update.md

      # 8. Auto Review & Merge PR
      - name: Auto Review and Merge
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          TARGET_REPO="${GITHUB_REPOSITORY}"
          PR_LIST=$(gh pr list --state open --repo "$TARGET_REPO" --json number -q '.[].number')
          if [ -n "$PR_LIST" ]; then
            PR_NUM=$(echo "$PR_LIST" | shuf -n1)
            gh pr review "$PR_NUM" --comment --body "ü§ñ Ëá™Âä®ÂÆ°Êü•ÔºöLGTMÔºÅ"
            gh pr merge "$PR_NUM" --squash --delete-branch --repo "$TARGET_REPO" --admin
            echo "‚úÖ Ëá™Âä®ÂêàÂπ∂‰∫Ü PR #$PR_NUM" >> update.md
          fi

      # 9. Auto Close Issues
      - name: Auto Close Issues
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          TARGET_REPO="${GITHUB_REPOSITORY}"
          ISSUE_LIST=$(gh issue list --state open --repo "$TARGET_REPO" --json number -q '.[].number')
          if [ -n "$ISSUE_LIST" ]; then
            ISSUE_NUM=$(echo "$ISSUE_LIST" | shuf -n1)
            gh issue close "$ISSUE_NUM" --repo "$TARGET_REPO"
            echo "üö´ Ëá™Âä®ÂÖ≥Èó≠‰∫Ü Issue #$ISSUE_NUM" >> update.md
          else
            echo "üéâ Ê≤°ÊúâÈúÄË¶ÅÂÖ≥Èó≠ÁöÑ Issue" >> update.md

      # 11. Star & Fork all repos of a specific user (with duplicate check)
      - name: Star & Fork user repos
        if: steps.lazy.outputs.lazy != 'true'
        id: starforkuser
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          TARGET_USER="MooCheelee"  # üëà ÊîπÊàê‰Ω†Ë¶ÅÊìç‰ΩúÁöÑ GitHub Áî®Êà∑Âêç

          echo "ÂºÄÂßãÂ§ÑÁêÜ $TARGET_USER ÁöÑ‰ªìÂ∫ì ‚≠êüç¥"
          repos=$(gh repo list $TARGET_USER --json nameWithOwner -q '.[].nameWithOwner')

          STAR_COUNT=0
          FORK_COUNT=0

          for repo in $repos; do
            echo "Ê£ÄÊü•‰ªìÂ∫ì: $repo"

            # ‚≠ê Ê£ÄÊü•ÊòØÂê¶Â∑≤Âä†Êòü
            if gh api "user/starred/$repo" &>/dev/null; then
              echo "‚úÖ Â∑≤Âä†ÊòüËøá $repoÔºåË∑≥Ëøá ‚≠ê"
            else
              gh api --method PUT "user/starred/$repo"
              echo "‚≠ê Starred $repo" >> update.md
              STAR_COUNT=$((STAR_COUNT+1))
            fi

            # üç¥ Ê£ÄÊü•ÊòØÂê¶Â∑≤ Fork
            USERNAME=$(echo "$repo" | cut -d'/' -f1)
            REPONAME=$(echo "$repo" | cut -d'/' -f2)
            MY_REPO="${GITHUB_ACTOR}/${REPONAME}"

            if gh repo view "$MY_REPO" &>/dev/null; then
              echo "‚úÖ Â∑≤ Fork Ëøá $repoÔºåË∑≥Ëøá üç¥"
            else
              gh repo fork "$repo" --clone=false --default-branch-only
              echo "üç¥ Forked $repo" >> update.md
              FORK_COUNT=$((FORK_COUNT+1))
            fi
          done

          echo "‚≠ê ÂÖ±Êñ∞Â¢û $STAR_COUNT ‰∏™ Star, üç¥ ÂÖ±Êñ∞Â¢û $FORK_COUNT ‰∏™ Fork" >> update.md

          echo "STAR_USER_COUNT=$STAR_COUNT" >> $GITHUB_OUTPUT
          echo "FORK_USER_COUNT=$FORK_COUNT" >> $GITHUB_OUTPUT

      # 11. Clean up old merged branches
      - name: Clean up old merged branches
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          TARGET_REPO="${GITHUB_REPOSITORY}"
          NOW=$(date +%s)
          gh pr list --state merged --repo "$TARGET_REPO" --json number,headRefName,mergedAt -q '.[]' | while read pr; do
            PR_NUM=$(echo "$pr" | jq -r '.number')
            BRANCH=$(echo "$pr" | jq -r '.headRefName')
            MERGED_AT=$(echo "$pr" | jq -r '.mergedAt')
            MERGED_TS=$(date -u -d "$MERGED_AT" +%s)
            AGE=$(( (NOW - MERGED_TS) / 86400 ))
            if [[ "$BRANCH" == daily-pr-* && $AGE -gt 7 ]]; then
              git push origin --delete "$BRANCH" || true
            fi
          done

      # 12. Daily summary
      - name: Write summary
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_USER: ${{ secrets.GH_USER }}
          GH_EMAIL: ${{ secrets.GH_EMAIL }}
        run: |
          NOW=$(date +"%Y-%m-%d %H:%M:%S")
          LOG_FILE="update.md"
          LOG_COUNT=$(grep -c 'üå±' $LOG_FILE || echo 0)
          ISSUE_COUNT=$(grep -c 'üìù ÂàõÂª∫‰∫Ü‰∏Ä‰∏™ Issue' $LOG_FILE || echo 0)
          PR_COUNT=$(grep -c 'üì¶ Êèê‰∫§‰∫Ü‰∏Ä‰∏™ PR' $LOG_FILE || echo 0)
          MERGED_COUNT=$(grep -c '‚úÖ Ëá™Âä®ÂêàÂπ∂‰∫Ü PR' $LOG_FILE || echo 0)
          STAR_COUNT=$(grep -c '‚≠ê' $LOG_FILE || echo 0)
          FORK_COUNT=$(grep -c 'üç¥' $LOG_FILE || echo 0)
          CLEAN_LOG_COUNT=$(grep -c 'Ê∏ÖÁêÜË∂ÖËøá 7 Â§©ÁöÑÊóßÊó•Âøó' $LOG_FILE || echo 0)
          CLEAN_BRANCH_COUNT=$(grep -c 'üóëÔ∏è Âà†Èô§Â∑≤ÂêàÂπ∂Ë∂ÖËøá 7 Â§©ÁöÑÂàÜÊîØ' $LOG_FILE || echo 0)

          echo -e "\n### üåô ‰ªäÊó•ÊÄªÁªì" >> "$LOG_FILE"
          echo "[$NOW] ‰ªäÊó•‰ªªÂä°ÂÆåÊàê ‚úÖ" >> "$LOG_FILE"
          echo "- üìù Êó•ÂøóÊù°ÁõÆ: $LOG_COUNT" >> "$LOG_FILE"
          echo "- üîß ÂàõÂª∫ Issue: $ISSUE_COUNT" >> "$LOG_FILE"
          echo "- üì¶ ÂàõÂª∫ PR: $PR_COUNT" >> "$LOG_FILE"
          echo "- ‚úÖ ÂêàÂπ∂ PR: $MERGED_COUNT" >> "$LOG_FILE"
          echo "- ‚≠ê Star: $STAR_COUNT" >> "$LOG_FILE"
          echo "- üç¥ Fork: $FORK_COUNT" >> "$LOG_FILE"
          echo "- üßπ Ê∏ÖÁêÜÊó•Âøó: $CLEAN_LOG_COUNT" >> "$LOG_FILE"
          echo "- üßπ Ê∏ÖÁêÜÂàÜÊîØ: $CLEAN_BRANCH_COUNT" >> "$LOG_FILE"

          # Êèê‰∫§ summary
          git config user.name "$GH_USER"
          git config user.email "$GH_EMAIL"
          git add "$LOG_FILE"
          git commit -m "chore: daily summary with counts" || echo "No changes"
          git fetch origin main
          git rebase origin/main || git rebase --abort
          git push origin HEAD:main || git push --force-with-lease origin HEAD:main
