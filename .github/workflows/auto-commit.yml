name: Daily GitHub Activity

env:
  TZ: Asia/Shanghai

on:
  schedule:
    - cron: '0 00 * * *'  # UTC 0 ç‚¹è§¦å‘ = åŒ—äº¬æ—¶é—´ 8 ç‚¹
  workflow_dispatch:

jobs:
  daily-activity:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_PAT }}

      # 2. Weekend lazy check
      - name: Weekend lazy check
        id: lazy
        run: |
          DOW=$(date +%u)
          if [ "$DOW" -gt 5 ] && [ $((RANDOM % 100)) -lt 20 ]; then
            echo "lazy=true" >> $GITHUB_OUTPUT
            echo "ğŸŒ™ $(date '+%Y-%m-%d') ä»Šå¤©å‘¨æœ«ï¼Œé€‰æ‹©æ‘¸é±¼ âœ¨" >> update.md
          else
            echo "lazy=false" >> $GITHUB_OUTPUT
          fi

      # 3. Random delay
      - name: Random delay
        if: steps.lazy.outputs.lazy != 'true'
        run: |
          DELAY=$((RANDOM % 2))
          sleep $DELAY

      # 4. Ensure update.md exists
      - name: Ensure update.md exists
        if: steps.lazy.outputs.lazy != 'true'
        run: |
          [ -f update.md ] || echo "# Daily Commit Log" > update.md

      # 5. Add daily date header
      - name: Add daily date header
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_USER: ${{ secrets.GH_USER }}
          GH_EMAIL: ${{ secrets.GH_EMAIL }}
        run: |
          git config user.name "$GH_USER"
          git config user.email "$GH_EMAIL"
          echo -e "\nğŸŒ™ $(date '+%Y-%m-%d')\n" >> update.md
          git add update.md
          git commit -m "chore: add daily date header" || echo "No changes"
          git push origin HEAD:main

      # 6. Commit update.md (æ¯å¤©å¿…æäº¤)
      - name: Commit update.md
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_USER: ${{ secrets.GH_USER }}
          GH_EMAIL: ${{ secrets.GH_EMAIL }}
        run: |
          git config user.name "$GH_USER"
          git config user.email "$GH_EMAIL"
          echo "[$(date '+%H:%M:%S')] ğŸŒ± æ—¥å¿—æ›´æ–°" >> update.md
          git add update.md
          git commit -m "chore: daily log update" || echo "No changes"
          git push origin HEAD:main

      # 7. Create Issue
      - name: Create Issue
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          GH_USER: ${{ secrets.GH_USER }}
          GH_EMAIL: ${{ secrets.GH_EMAIL }}
        run: |
          RAND=$((RANDOM % 100 + 1))
          git config user.name "$GH_USER"
          git config user.email "$GH_EMAIL"
          if [ $RAND -le 35 ]; then
            LABELS=("bug" "enhancement" "discussion")
            LABEL=${LABELS[$RANDOM % ${#LABELS[@]}]}
            gh issue create --title "Daily Issue - $(date '+%Y-%m-%d %H:%M:%S')" \
                            --body "éšæœºç”Ÿæˆæ¯æ—¥ Issue ğŸŒ±" \
                            --label "$LABEL" \
                            --repo $GITHUB_REPOSITORY
            echo "[$(date '+%H:%M:%S')] ğŸ“ åˆ›å»ºäº†ä¸€ä¸ª Issue ($LABEL)" >> update.md
          else
            echo "[$(date '+%H:%M:%S')] ğŸŒ¿ ä»Šå¤©ä¸åˆ›å»º Issue" >> update.md
          fi
          git add update.md
          git commit -m "chore: update issue log" || echo "No changes"
          git push origin HEAD:main

      # 8. Create Pull Request
      - name: Create Pull Request
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          GH_USER: ${{ secrets.GH_USER }}
          GH_EMAIL: ${{ secrets.GH_EMAIL }}
        run: |
          RAND=$((RANDOM % 100 + 1))
          git config user.name "$GH_USER"
          git config user.email "$GH_EMAIL"
          if [ $RAND -le 35 ]; then
            BRANCH="daily-pr-$(date '+%Y%m%d%H%M%S')"
            git checkout -b "$BRANCH"
            echo "[$(date '+%H:%M:%S')] ğŸ“¦ è‡ªåŠ¨ PR æ—¥å¿—" >> update.md
            git add update.md
            git commit -m "chore: daily PR update"
            git push origin "$BRANCH"
            gh pr create --title "Daily PR - $(date '+%Y-%m-%d %H:%M:%S')" \
                         --body "éšæœºç”Ÿæˆæ¯æ—¥ PR ğŸŒ±" \
                         --base main --head "$BRANCH" --repo $GITHUB_REPOSITORY
          else
            echo "[$(date '+%H:%M:%S')] ğŸŒ¿ ä»Šå¤©ä¸åˆ›å»º PR" >> update.md
          fi
          git add update.md
          git commit -m "chore: update PR log" || echo "No changes"
          git push origin HEAD:main

      # 9. Auto Review & Merge PR
      - name: Auto Review and Merge
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          GH_USER: ${{ secrets.GH_USER }}
          GH_EMAIL: ${{ secrets.GH_EMAIL }}
        run: |
          git config user.name "$GH_USER"
          git config user.email "$GH_EMAIL"
          PR_LIST=$(gh pr list --state open --repo "$GITHUB_REPOSITORY" --json number -q '.[].number')
          if [ -n "$PR_LIST" ]; then
            PR_NUM=$(echo "$PR_LIST" | shuf -n1)
            gh pr review "$PR_NUM" --comment --body "ğŸ¤– è‡ªåŠ¨å®¡æŸ¥ï¼šLGTMï¼"
            gh pr merge "$PR_NUM" --squash --delete-branch --repo "$GITHUB_REPOSITORY" --admin
            echo "[$(date '+%H:%M:%S')] âœ… è‡ªåŠ¨åˆå¹¶äº† PR #$PR_NUM" >> update.md
            git add update.md
            git commit -m "chore: update merged PR log" || echo "No changes"
            git push origin HEAD:main
          fi

      # 10. Auto Close Issues
      - name: Auto Close Issues
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          GH_USER: ${{ secrets.GH_USER }}
          GH_EMAIL: ${{ secrets.GH_EMAIL }}
        run: |
          git config user.name "$GH_USER"
          git config user.email "$GH_EMAIL"
          ISSUE_LIST=$(gh issue list --state open --repo "$GITHUB_REPOSITORY" --json number -q '.[].number')
          if [ -n "$ISSUE_LIST" ]; then
            ISSUE_NUM=$(echo "$ISSUE_LIST" | shuf -n1)
            gh issue close "$ISSUE_NUM" --repo "$GITHUB_REPOSITORY"
            echo "[$(date '+%H:%M:%S')] ğŸš« è‡ªåŠ¨å…³é—­äº† Issue #$ISSUE_NUM" >> update.md
          else
            echo "[$(date '+%H:%M:%S')] ğŸ‰ æ²¡æœ‰éœ€è¦å…³é—­çš„ Issue" >> update.md
          fi
          git add update.md
          git commit -m "chore: update closed issue log" || echo "No changes"
          git push origin HEAD:main

      # 11. Star & Fork all repos of a specific user (with duplicate check)
      - name: Star & Fork user repos
        if: steps.lazy.outputs.lazy != 'true'
        id: starforkuser
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          TARGET_USER="MooCheelee"
          echo "å¼€å§‹å¤„ç† $TARGET_USER çš„ä»“åº“ â­ğŸ´"

          # è·å–ç›®æ ‡ç”¨æˆ·æ‰€æœ‰ä»“åº“
          repos=$(gh repo list $TARGET_USER --json nameWithOwner -q '.[].nameWithOwner')

          # è·å–è‡ªå·±å·² Star ä»“åº“
          starred=$(gh repo list --json nameWithOwner -q '.[].nameWithOwner')
          starred_set=$(echo "$starred" | sort)

          # è·å–è‡ªå·±æ‰€æœ‰ä»“åº“ï¼ˆç”¨äºåˆ¤æ–­ Forkï¼‰
          my_repos=$(gh repo list $GITHUB_ACTOR --json nameWithOwner -q '.[].nameWithOwner')
          my_repos_set=$(echo "$my_repos" | sort)

          # å¹¶è¡Œé™åˆ¶ï¼ˆå¯è°ƒæ•´ï¼Œå¤ªé«˜å¯èƒ½è§¦å‘ rate limitï¼‰
          MAX_PARALLEL=8
          CURRENT_JOBS=0

          # åˆ›å»ºæ—¥å¿—æ–‡ä»¶
          : > update.md

          increment_jobs() {
            CURRENT_JOBS=$((CURRENT_JOBS + 1))
          }

          decrement_jobs() {
            CURRENT_JOBS=$((CURRENT_JOBS - 1))
          }

          process_repo_async() {
            repo=$1

            log=""
            star_count=0
            fork_count=0

            # â­ Star åˆ¤æ–­
            if echo "$starred_set" | grep -qx "$repo"; then
              :
            else
              gh api --method PUT "user/starred/$repo"
              log+="â­ Starred $repo\n"
              star_count=1
            fi

            # ğŸ´ Fork åˆ¤æ–­
            REPONAME=$(echo "$repo" | cut -d"/" -f2)
            MY_REPO="${GITHUB_ACTOR}/${REPONAME}"

            if echo "$my_repos_set" | grep -qx "$MY_REPO"; then
              :
            else
              gh repo fork "$repo" --clone=false --default-branch-only
              log+="ğŸ´ Forked $repo\n"
              fork_count=1
            fi

            # å†™å…¥æ—¥å¿—ï¼ˆåŸå­æ“ä½œï¼‰
            {
            echo -e "$log"
            echo "$star_count,$fork_count"
            } >> update.tmp
          }

          # éå†ä»“åº“
          for repo in $repos; do
            # æ§åˆ¶å¹¶è¡Œæ•°
            while (( CURRENT_JOBS >= MAX_PARALLEL )); do
              sleep 0.5
            done

            process_repo_async "$repo" &
            increment_jobs
          done

          # ç­‰å¾…æ‰€æœ‰åå°ä»»åŠ¡å®Œæˆ
          wait

          # æ±‡æ€»ç»“æœ
          STAR_COUNT=0
          FORK_COUNT=0
          LOGS=""
 
          while IFS= read -r line; do
            if [[ $line == *,* ]]; then
              sc=$(echo $line | cut -d',' -f1)
              fc=$(echo $line | cut -d',' -f2)
              STAR_COUNT=$((STAR_COUNT + sc))
              FORK_COUNT=$((FORK_COUNT + fc))
            else
              LOGS+="$line\n"
            fi
          done < update.tmp

          # å†™æœ€ç»ˆæ—¥å¿—
          echo -e "$LOGS" >> update.md
          echo "â­ å…±æ–°å¢ $STAR_COUNT ä¸ª Star, ğŸ´ å…±æ–°å¢ $FORK_COUNT ä¸ª Fork" >> update.md

          echo "STAR_USER_COUNT=$STAR_COUNT" >> $GITHUB_OUTPUT
          echo "FORK_USER_COUNT=$FORK_COUNT" >> $GITHUB_OUTPUT

          # åˆ é™¤ä¸´æ—¶æ–‡ä»¶
          rm -f update.tmp

      # 12. Clean up old merged branches
      - name: Clean up old merged branches
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          GH_USER: ${{ secrets.GH_USER }}
          GH_EMAIL: ${{ secrets.GH_EMAIL }}
        run: |
          git config user.name "$GH_USER"
          git config user.email "$GH_EMAIL"
          NOW=$(date +%s)
          gh pr list --state merged --repo "$GITHUB_REPOSITORY" --json number,headRefName,mergedAt -q '.[]' | while read pr; do
            BRANCH=$(echo "$pr" | jq -r '.headRefName')
            MERGED_AT=$(echo "$pr" | jq -r '.mergedAt')
            MERGED_TS=$(date -u -d "$MERGED_AT" +%s)
            AGE=$(( (NOW - MERGED_TS) / 86400 ))
            if [[ "$BRANCH" == daily-pr-* && $AGE -gt 7 ]]; then
              if git ls-remote --exit-code --heads origin "$BRANCH" >/dev/null; then
                git push origin --delete "$BRANCH"
                echo "[$(date '+%H:%M:%S')] ğŸ—‘ï¸ åˆ é™¤å·²åˆå¹¶è¶…è¿‡ 7 å¤©çš„åˆ†æ”¯: $BRANCH" >> update.md
              fi
            fi
          done
          git add update.md
          git commit -m "chore: update cleaned branches log" || echo "No changes"
          git push origin HEAD:main

       # 13. Clean up update.md older than 7 days
      - name: Clean up old update.md entries
        if: steps.lazy.outputs.lazy != 'true'
        run: |
          git config user.name "${GH_USER}"
          git config user.email "${GH_EMAIL}"

          TMP_FILE=$(mktemp)
          TODAY=$(date +%s)
          DAYS_TO_KEEP=7

          # è¯»å– update.mdï¼ŒæŒ‰æ—¥æœŸå—å¤„ç†
          awk -v today=$TODAY -v days=$DAYS_TO_KEEP '
          BEGIN { keep_block=0 }
          /^ğŸŒ™ [0-9]{4}-[0-9]{2}-[0-9]{2}/ {
              # æå–æ—¥æœŸ
              gsub(/^ğŸŒ™ /,"",$0)
              split($0, a, "-")
              log_ts = mktime(a[1]" "a[2]" "a[3]" 0 0 0")
              if ((today - log_ts) <= days*86400) {
                  keep_block=1
              } else {
                  keep_block=0
              }
          }
          {
              if (keep_block) print
          }
          ' update.md > "$TMP_FILE"

          mv "$TMP_FILE" update.md

          git add update.md
          git commit -m "chore: clean update.md older than 7 days" || echo "No changes"
          git push origin HEAD:main
