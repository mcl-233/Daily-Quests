# Name: Daily GitHub Activity
# Description: æ¨¡æ‹Ÿæ—¥å¸¸ GitHub æ´»è·ƒåº¦ï¼Œè‡ªåŠ¨æäº¤æ—¥å¿—ã€åˆ›å»º Issue å’Œ PRï¼Œå¹¶è‡ªåŠ¨ Review å’Œåˆå¹¶ã€‚

name: Daily GitHub Activity

on:
  schedule:
    - cron: '0 0 * * *' # æ¯å¤© UTC 0 ç‚¹è§¦å‘
  workflow_dispatch:

# æƒé™è®¾ç½®ï¼Œç¡®ä¿ GITHUB_TOKEN æœ‰è¶³å¤Ÿçš„æƒé™æ¥å†™å†…å®¹å’Œå¤„ç† PR
permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  daily-activity:
    runs-on: ubuntu-latest

    steps:
      # æ‹‰å–ä»“åº“
      - name: Checkout repo
        uses: actions/checkout@v3

      # éšæœºå»¶è¿Ÿ 0~24 å°æ—¶ï¼Œæ¨¡æ‹Ÿæ›´è‡ªç„¶çš„ç”¨æˆ·è¡Œä¸º
      # æ³¨æ„ï¼šè¿™ä¼šå¢åŠ å·¥ä½œæµæ‰§è¡Œæ—¶é—´çš„ä¸ç¡®å®šæ€§
      - name: Random delay
        run: |
          DELAY=$((RANDOM % 1))
          echo "ç­‰å¾… $DELAY ç§’å†æ‰§è¡Œ..."
          sleep $DELAY

      # å¼•å…¥å¹¶è¿è¡Œæ¶ˆæ¯è„šæœ¬ï¼Œè·å–éšæœºçš„æäº¤ä¿¡æ¯å’Œ PR æ–‡æœ¬
      - name: Load random messages
        id: messages
        run: |
          # ç¡®ä¿è„šæœ¬å¯æ‰§è¡Œ
          chmod +x scripts/messages.sh
          # å°†è„šæœ¬çš„è¾“å‡ºä¿å­˜ä¸º GitHub Actions çš„ç¯å¢ƒå˜é‡
          echo "commit_msg=$(./scripts/messages.sh get_random_commit_message)" >> $GITHUB_OUTPUT
          echo "pr_title=$(./scripts/messages.sh get_random_pr_title)" >> $GITHUB_OUTPUT
          echo "pr_body=$(./scripts/messages.sh get_random_pr_body)" >> $GITHUB_OUTPUT

      # --- æäº¤æ—¥å¿— (Commit) ---
      - name: Append and commit daily log
        run: |
          LOG_FILE="update.md"
          
          # ç¡®ä¿æ—¥å¿—æ–‡ä»¶å­˜åœ¨å¹¶æœ‰åˆå§‹å†…å®¹
          if [ ! -f $LOG_FILE ]; then
            echo "# Daily Commit Log" > $LOG_FILE
          fi
          
          # æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼Œå¦‚æœå¤§äº 1MB åˆ™æ¸…ç©º
          if [[ $(stat -c %s "$LOG_FILE") -gt 1048576 ]]; then
            echo "æ–‡ä»¶è¶…è¿‡ 1MBï¼Œæ­£åœ¨æ¸…ç©º..."
            echo "# Daily Commit Log" > $LOG_FILE
          fi
          
          # è¿½åŠ æ¯æ—¥æ—¥å¿—
          echo "$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S') - è‡ªåŠ¨æäº¤æ—¥å¿— ğŸŒ±" >> $LOG_FILE
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŠ¨ï¼Œå¦‚æœæœ‰åˆ™æäº¤
          if ! git diff --quiet --exit-code $LOG_FILE; then
            echo "å‘ç°æ–‡ä»¶å˜åŠ¨ï¼Œæ­£åœ¨æäº¤..."
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add $LOG_FILE
            git commit -m "${{ steps.messages.outputs.commit_msg }}"
            git push origin main
          else
            echo "æ–‡ä»¶æ— å˜åŠ¨ï¼Œè·³è¿‡æäº¤ã€‚"
          fi

      # --- éšæœºåˆ›å»º Issue ---
      - name: Randomly create Issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RAND=$((RANDOM % 100))
          if [ $RAND -lt 30 ]; then
            echo "æ­£åœ¨ç”Ÿæˆæ¯æ—¥ Issue..."
            gh issue create --title "Daily Issue - $(TZ='Asia/Shanghai' date '+%Y-%m-%d')" \
                             --body "éšæœºç”Ÿæˆæ¯æ—¥ Issue ğŸŒ±"
          else
            echo "è·³è¿‡åˆ›å»º Issueã€‚"
          fi
          
      # --- éšæœºåˆ›å»º PR å¹¶è‡ªåŠ¨åˆå¹¶ ---
      - name: Randomly create PR, auto-review and merge
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RAND=$((RANDOM % 100))
          if [ $RAND -lt 30 ]; then
            echo "æ­£åœ¨ç”Ÿæˆæ¯æ—¥ PR..."
            BRANCH="daily-pr-$(date '+%Y%m%d%H%M%S')"
            LOG_FILE="update.md"

            git checkout -b $BRANCH
            echo "$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S') - è‡ªåŠ¨ PR æ—¥å¿— ğŸŒ±" >> $LOG_FILE
            git add $LOG_FILE
            git commit -m "${{ steps.messages.outputs.pr_title }}"
            git push origin $BRANCH

            # åˆ›å»º PR
            PR_URL=$(gh pr create --title "${{ steps.messages.outputs.pr_title }}" \
                                  --body "${{ steps.messages.outputs.pr_body }}" \
                                  --base main \
                                  --head $BRANCH \
                                  --repo $GITHUB_REPOSITORY)
            
            PR_NUM=$(echo "$PR_URL" | sed 's:.*/::')
            echo "æˆåŠŸåˆ›å»º PR: $PR_URL"
            echo "PR #$PR_NUM ç­‰å¾…è‡ªåŠ¨ Review å’Œåˆå¹¶..."
            
            # æäº¤ Review
            gh pr review "$PR_NUM" --comment --body "ğŸ¤– è‡ªåŠ¨å®¡æŸ¥ï¼šçœ‹èµ·æ¥ä¸é”™ï¼Œå‡†å¤‡åˆå¹¶ï¼"
            
            # è‡ªåŠ¨åˆå¹¶ PR
            gh pr merge "$PR_NUM" --squash --delete-branch
            echo "PR #$PR_NUM å·²è‡ªåŠ¨åˆå¹¶å¹¶åˆ é™¤åˆ†æ”¯ã€‚"
          else
            echo "è·³è¿‡åˆ›å»º PRã€‚"
          fi
          
      # --- éšæœºç»™å…¶ä»–ä»“åº“åŠ æ˜Ÿ ---
      - name: Randomly star a repo
        env:
          # æ­¤å¤„å¿…é¡»ä½¿ç”¨ PATï¼Œå› ä¸º GITHUB_TOKEN æ— æ³•ç»™å¤–éƒ¨ä»“åº“åŠ æ˜Ÿ
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          RAND=$((RANDOM % 100))
          # 30% æ¦‚ç‡æ‰§è¡ŒåŠ æ˜Ÿæ“ä½œ
          if [ $RAND -lt 30 ]; then
            echo "æ­£åœ¨å¯»æ‰¾æœ‰è¶£çš„ä»“åº“å¹¶åŠ æ˜Ÿ..."
            
            # æ¨¡æ‹Ÿâ€œé€›â€ GitHub çš„è¡Œä¸ºï¼Œéšæœºè·å–çƒ­é—¨é¡¹ç›®
            # ä½¿ç”¨ GitHub CLI çš„ gh search å‘½ä»¤æ¥æŸ¥æ‰¾æœ€è¿‘çƒ­é—¨çš„é¡¹ç›®
            REPO_TO_STAR=$(gh search repos "stars:>10 created:>$(( $(date +%s) - 86400 * 30 ))" \
                           --sort stars --order desc --limit 10 \
                           --jq '.[].fullName' | shuf -n1)
            
            # å¦‚æœæ‰¾åˆ°ä»“åº“ï¼Œæ‰§è¡ŒåŠ æ˜Ÿæ“ä½œ
            if [ -n "$REPO_TO_STAR" ]; then
              echo "å‘ç°ä¸€ä¸ªæœ‰è¶£çš„é¡¹ç›®ï¼š$REPO_TO_STAR"
              # ä½¿ç”¨ GitHub CLI çš„ gh api è°ƒç”¨ REST API æ¥åŠ æ˜Ÿ
              gh api --method PUT "user/starred/$REPO_TO_STAR"
              echo "å·²æˆåŠŸåŠ æ˜Ÿã€‚"
            else
          else
            echo"è·³è¿‡åŠ æ˜Ÿæ“ä½œã€‚"
          fi

      # --- å®šæœŸæ¸…ç†å·²åˆå¹¶çš„æ—§åˆ†æ”¯ï¼ˆ7å¤©å‰ï¼‰ ---
      - name: Clean up old merged branches
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "å¼€å§‹æ¸…ç† 7 å¤©å‰å·²åˆå¹¶çš„ PR åˆ†æ”¯..."
          
          # ä½¿ç”¨ gh å‘½ä»¤è·å–æ‰€æœ‰å·²åˆå¹¶çš„ PRï¼Œå¹¶æŒ‰æ—¶é—´å€’åºæ’åº
          # è¿‡æ»¤å‡º 7 å¤©å‰åˆå¹¶çš„ PRï¼Œè·å–å…¶åˆ†æ”¯å
          BRANCHES_TO_DELETE=$(gh pr list --state merged --json headRefName,mergedAt --jq '.[] | select(.mergedAt | fromdateiso8601 < (now - 604800)) | .headRefName' --paginate)

          if [ -z "$BRANCHES_TO_DELETE" ]; then
            echo "æ²¡æœ‰æ‰¾åˆ°éœ€è¦æ¸…ç†çš„æ—§åˆ†æ”¯ã€‚"
            exit 0
          fi

          echo "$BRANCHES_TO_DELETE" | while read branch; do
            # æ£€æŸ¥åˆ†æ”¯åæ˜¯å¦ä»¥ "daily-pr-" å¼€å¤´ï¼Œé˜²æ­¢è¯¯åˆ 
            if [[ "$branch" == "daily-pr-"* ]]; then
              echo "æ­£åœ¨åˆ é™¤åˆ†æ”¯: $branch"
              git push origin --delete $branch || true
            else
              echo "è·³è¿‡é 'daily-pr-' å¼€å¤´çš„åˆ†æ”¯: $branch"
            fi
          done
          echo "æ¸…ç†å®Œæˆã€‚"
